<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard Learning Engine</title>
    <style>
        :root {
            --primary-color: #007bff;
            --green-color: #28a745;
            --orange-color: #fd7e14;
            --red-color: #dc3545;
            --light-gray: #f0f2f5;
            --medium-gray: #e9e9eb;
            --dark-gray: #555;
            --white: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        html { box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--light-gray);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Sidebar (Mobile First) --- */
        #sidebar {
            position: fixed; top: 0; left: 0; height: 100%; width: 300px;
            background-color: var(--white); box-shadow: var(--shadow);
            display: flex; flex-direction: column; z-index: 200;
            transform: translateX(-100%); transition: transform 0.3s ease-in-out;
        }
        body.sidebar-open #sidebar { transform: translateX(0); }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--medium-gray); }
        .sidebar-header h2 { margin: 0; color: var(--primary-color); }
        .tabs { display: flex; margin-top: 15px; }
        .tab-btn { flex: 1; padding: 10px; background: var(--light-gray); border: none; cursor: pointer; font-size: 1rem; color: var(--dark-gray); }
        .tab-btn.active { background: var(--primary-color); color: var(--white); font-weight: bold; }
        .sidebar-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #set-list, #stats-list { list-style: none; padding: 0; margin: 0; }
        .set-item { display: flex; align-items: center; padding: 10px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; }
        .set-item:hover { background-color: var(--light-gray); }
        .set-item-checkbox { margin-right: 15px; transform: scale(1.2); }
        .set-details { flex-grow: 1; }
        .set-name { font-size: 1rem; }
        .set-date { font-size: 0.8rem; color: var(--dark-gray); margin-top: 4px; }
        .delete-set { background: none; border: none; cursor: pointer; font-size: 1.2rem; color: var(--dark-gray); opacity: 0.5; transition: opacity 0.2s; }
        .set-item:hover .delete-set { opacity: 1; }
        
        .stats-explanation { text-align: left; font-size: 0.9rem; background-color: var(--medium-gray); border-radius: 8px; padding: 15px; margin-bottom: 20px; border-left: 4px solid var(--primary-color); }
        .stats-explanation h4 { margin-top: 0; color: var(--dark-gray); }
        .stats-explanation p { margin-bottom: 10px; }
        .stats-explanation ul { padding-left: 20px; margin: 0; color: #333; }

        .stat-item { margin-bottom: 15px; }
        .stat-item .set-name { font-weight: bold; }
        .mastery-bar { width: 100%; background: var(--medium-gray); border-radius: 5px; height: 10px; margin-top: 5px; overflow: hidden; }
        .mastery-bar-fill { height: 100%; width: 0%; background: var(--green-color); transition: width 0.5s; }
        .sidebar-footer { padding: 20px; border-top: 1px solid var(--medium-gray); }
        .action-button { width: 100%; padding: 15px; color: var(--white); border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; margin-bottom: 10px; }
        #start-study-btn { background-color: var(--green-color); }
        #upload-new-set-btn { background-color: var(--primary-color); }

        /* --- Main Content (Mobile First) --- */
        #main-content { width: 100%; height: 100%; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; position: relative; }
        .menu-btn { background: var(--white); border: none; font-size: 1.5rem; padding: 8px 12px; border-radius: 8px; cursor: pointer; position: absolute; top: 20px; left: 20px; z-index: 150; box-shadow: var(--shadow); }
        .content-view { width: 100%; max-width: 600px; text-align: center; margin: auto; }
        #welcome-view { padding-top: 50px; }
        #welcome-view h2 { font-size: 1.5rem; }
        #welcome-view p { font-size: 1.1rem; color: var(--dark-gray); }
        #flashcard-view { display: none; }
        .flashcard-container { perspective: 1000px; margin-bottom: 20px; }
        .flashcard { width: 100%; min-height: 350px; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 25px; border-radius: 15px; overflow-y: auto; background-color: var(--white); box-shadow: var(--shadow); }
        .back { background-color: var(--medium-gray); transform: rotateY(180deg); }
        .question, .answer, .explanation { text-align: left; width: 100%; }
        .question { font-size: 1.1rem; line-height: 1.5; }
        .answer { font-size: 1rem; font-weight: bold; color: var(--primary-color); margin-bottom: 15px; }
        .explanation { font-style: italic; line-height: 1.5; font-size: 0.9rem;}
        
        .study-info { display: flex; justify-content: space-between; margin-top: 10px; }
        .card-counter, .times-seen-counter { font-size: 0.9rem; color: var(--dark-gray); }
        
        .navigation { display: flex; justify-content: space-around; align-items: center; margin-top: 10px; }
        .confidence-buttons { display: none; width: 100%; }
        .confidence-btn { flex: 1; margin: 0 5px; border: 2px solid; color: var(--white); border-radius: 8px; cursor: pointer; padding: 15px; font-size: 1rem; font-weight: bold;}
        #btn-hard { background-color: var(--red-color); border-color: var(--red-color); }
        #btn-good { background-color: var(--orange-color); border-color: var(--orange-color); }
        #btn-easy { background-color: var(--green-color); border-color: var(--green-color); }
        .progress-container { width: 100%; background-color: #e0e0e0; border-radius: 5px; margin-bottom: 20px; }
        .progress-bar { width: 0; height: 10px; background-color: var(--primary-color); border-radius: 5px; transition: width 0.3s ease-in-out; }

        /* --- Modal & Overlay --- */
        .modal-overlay, .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 199; display: none; justify-content: center; align-items: center; }
        body.sidebar-open .sidebar-overlay { display: block; }
        .modal-content { background-color: var(--white); padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; box-shadow: var(--shadow); }
        .modal-content h3 { margin-top: 0; }
        .modal-content input { width: 100%; padding: 10px; box-sizing: border-box; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 5px; }
        .modal-actions { text-align: right; }
        .modal-actions button { background: none; border: none; font-size: 1rem; cursor: pointer; padding: 10px; }
        .modal-actions .save-btn { background-color: var(--primary-color); color: var(--white); border-radius: 5px; }

        /* --- Desktop Layout --- */
        @media (min-width: 768px) {
            .menu-btn, .sidebar-overlay { display: none !important; }
            #sidebar { position: static; transform: translateX(0); flex-shrink: 0; }
            #main-content { padding: 40px; }
        }
    </style>
</head>
<body id="body-element">

    <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <div class="modal-overlay" id="nameSetModal">
        <div class="modal-content">
            <h3>Name Your New Flashcard Set</h3>
            <input type="text" id="setNameInput" placeholder="e.g., SD-WAN Chapter 5">
            <div class="modal-actions">
                <button id="cancelNameBtn">Cancel</button>
                <button id="saveNameBtn" class="save-btn">Save</button>
            </div>
        </div>
    </div>

    <aside id="sidebar">
        <div class="sidebar-header">
            <h2>Learning Engine</h2>
            <div class="tabs">
                <button class="tab-btn active" data-tab="sets">Sets</button>
                <button class="tab-btn" data-tab="stats">Stats</button>
            </div>
        </div>
        <div class="sidebar-content">
            <div id="sets-content" class="tab-content active">
                <ul id="set-list"></ul>
            </div>
            <div id="stats-content" class="tab-content">
                <div class="stats-explanation">
                    <h4>How Mastery Works</h4>
                    <p>Mastery shows the percentage of cards you are very confident with. Only cards marked as <strong>"Easy"</strong> contribute to this stat.</p>
                    <ul>
                        <li><strong>Good</strong> = You're still learning it.</li>
                        <li><strong>Easy</strong> = You have mastered it.</li>
                    </ul>
                </div>
                <ul id="stats-list"></ul>
            </div>
        </div>
        <div class="sidebar-footer">
            <button id="start-study-btn" class="action-button">🧠 Start Study Session</button>
            <button id="upload-new-set-btn" class="action-button">＋ Upload New Set</button>
        </div>
    </aside>

    <main id="main-content">
        <button class="menu-btn" id="menu-btn">☰</button>

        <div id="welcome-view" class="content-view">
            <h2>Welcome to your Learning Engine!</h2>
            <p>Select one or more sets from the menu and hit "Start Study Session" to begin.</p>
        </div>

        <div id="flashcard-view" class="content-view">
            <h1 id="flashcard-set-title"></h1>
            <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
            <div class="flashcard-container">
                <div class="flashcard" id="flashcard">
                    <div class="face front"><div id="question" class="question"></div></div>
                    <div class="face back">
                        <div id="answer" class="answer"></div>
                        <div id="explanation" class="explanation"></div>
                    </div>
                </div>
            </div>
            <div class="navigation">
                <div class="confidence-buttons" id="confidence-buttons">
                    <button id="btn-hard" class="confidence-btn">Hard</button>
                    <button id="btn-good" class="confidence-btn">Good</button>
                    <button id="btn-easy" class="confidence-btn">Easy</button>
                </div>
            </div>
            <div class="study-info">
                <div class="card-counter" id="cardCounter"></div>
                <div class="times-seen-counter" id="timesSeenCounter"></div>
            </div>
        </div>
    </main>

    <script>
        // --- DOM Elements ---
        const body = document.getElementById('body-element');
        const setList = document.getElementById('set-list');
        const statsList = document.getElementById('stats-list');
        const uploadNewSetBtn = document.getElementById('upload-new-set-btn');
        const startStudyBtn = document.getElementById('start-study-btn');
        const csvFileInput = document.getElementById('csvFileInput');
        const menuBtn = document.getElementById('menu-btn');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const welcomeView = document.getElementById('welcome-view');
        const flashcardView = document.getElementById('flashcard-view');
        const flashcardSetTitle = document.getElementById('flashcard-set-title');
        const nameSetModal = document.getElementById('nameSetModal');
        const setNameInput = document.getElementById('setNameInput');
        const cancelNameBtn = document.getElementById('cancelNameBtn');
        const saveNameBtn = document.getElementById('saveNameBtn');
        const questionEl = document.getElementById('question');
        const answerEl = document.getElementById('answer');
        const explanationEl = document.getElementById('explanation');
        const flashcardEl = document.getElementById('flashcard');
        const progressBar = document.getElementById('progressBar');
        const cardCounter = document.getElementById('cardCounter');
        const timesSeenCounter = document.getElementById('timesSeenCounter');
        const confidenceButtons = document.getElementById('confidence-buttons');
        const btnHard = document.getElementById('btn-hard');
        const btnGood = document.getElementById('btn-good');
        const btnEasy = document.getElementById('btn-easy');

        // --- App State ---
        let allSets = [];
        let studyQueue = [];
        let currentCardIndexInQueue = 0;
        let uploadedFile = null;

        // SRS Intervals (in minutes)
        const SRS_INTERVALS = { HARD: 5, GOOD: 24 * 60, EASY: 4 * 24 * 60 };

        // --- Data Persistence ---
        async function loadSetsFromServer() {
            try {
                const response = await fetch('load.php');
                if (!response.ok) { throw new Error('Network response was not ok.'); }
                const data = await response.json();
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error("Load Error:", error);
                // alert("Failed to load your data. Starting with a blank session.");
                return []; 
            }
        }

        async function saveSetsToServer() {
            try {
                await fetch('save.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(allSets),
                });
            } catch (error) {
                console.error("Save Error:", error);
                alert("Failed to save your progress. Your latest changes might not be synced.");
            }
        }

        // --- Core Functions ---
        async function initialize() {
            allSets = await loadSetsFromServer();
            renderSidebar();
            setupEventListeners();
        }

        function setupEventListeners() {
            menuBtn.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);
            uploadNewSetBtn.addEventListener('click', () => {
                if (window.innerWidth < 768 && body.classList.contains('sidebar-open')) toggleSidebar();
                csvFileInput.click();
            });
            startStudyBtn.addEventListener('click', startStudySession);
            csvFileInput.addEventListener('change', handleFileSelect);
            cancelNameBtn.addEventListener('click', closeModal);
            saveNameBtn.addEventListener('click', processAndSaveSet);
            flashcardEl.addEventListener('click', () => {
                flashcardEl.classList.toggle('is-flipped');
                if (flashcardEl.classList.contains('is-flipped')) {
                    confidenceButtons.style.display = 'flex';
                }
            });
            btnHard.addEventListener('click', () => rateCard('HARD'));
            btnGood.addEventListener('click', () => rateCard('GOOD'));
            btnEasy.addEventListener('click', () => rateCard('EASY'));
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
            document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
            document.querySelector(`#${tabName}-content`).classList.add('active');
        }

        function toggleSidebar() { body.classList.toggle('sidebar-open'); }

        function renderSidebar() {
            setList.innerHTML = '';
            statsList.innerHTML = '';
            allSets.forEach((set, index) => {
                const setItem = document.createElement('li');
                setItem.className = 'set-item';
                setItem.innerHTML = `
                    <input type="checkbox" class="set-item-checkbox" data-index="${index}">
                    <div class="set-details">
                        <span class="set-name">${set.name}</span>
                        <span class="set-date">Uploaded: ${set.date}</span>
                    </div>
                    <button class="delete-set" data-index="${index}" title="Delete set">🗑️</button>
                `;
                setList.appendChild(setItem);

                const statItem = document.createElement('li');
                statItem.className = 'stat-item';
                const mastery = calculateMastery(set);
                statItem.innerHTML = `
                    <div class="set-name">${set.name}</div>
                    <div>Mastery: ${mastery.toFixed(0)}%</div>
                    <div class="mastery-bar"><div class="mastery-bar-fill" style="width: ${mastery}%;"></div></div>
                `;
                statsList.appendChild(statItem);
            });
            
            setList.querySelectorAll('.delete-set').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteSet(parseInt(e.currentTarget.dataset.index));
                });
            });
        }
        
        function calculateMastery(set) {
            if (!set.cards || set.cards.length === 0) return 0;
            const masteredCards = set.cards.filter(card => card.srsLevel === 'EASY').length;
            return (masteredCards / set.cards.length) * 100;
        }

        async function deleteSet(index) {
            if (confirm(`Are you sure you want to delete the set "${allSets[index].name}"?`)) {
                allSets.splice(index, 1);
                await saveSetsToServer();
                flashcardView.style.display = 'none';
                welcomeView.style.display = 'block';
                renderSidebar();
            }
        }
        
        function startStudySession() {
            const selectedIndexes = Array.from(document.querySelectorAll('.set-item-checkbox:checked')).map(cb => parseInt(cb.dataset.index));
            if (selectedIndexes.length === 0) {
                alert("Please select at least one set to study."); return;
            }
            const now = new Date().getTime();
            studyQueue = [];
            selectedIndexes.forEach(index => {
                if(allSets[index] && allSets[index].cards){
                    allSets[index].cards.forEach((card, cardIndex) => {
                        if (!card.srsLevel || (card.nextReviewDate && card.nextReviewDate <= now)) {
                            studyQueue.push({ setIndex: index, cardIndex: cardIndex });
                        }
                    });
                }
            });
            if (studyQueue.length === 0) {
                alert("No new or due cards in the selected sets. Great job!"); return;
            }
            studyQueue.sort(() => Math.random() - 0.5);
            currentCardIndexInQueue = 0;
            welcomeView.style.display = 'none';
            flashcardView.style.display = 'block';
            if (window.innerWidth < 768) toggleSidebar();
            displayCard();
        }

        async function rateCard(rating) {
            const cardInfo = studyQueue[currentCardIndexInQueue];
            const originalCard = allSets[cardInfo.setIndex].cards[cardInfo.cardIndex];
            originalCard.srsLevel = rating;
            const now = new Date().getTime();
            const interval = SRS_INTERVALS[rating] * 60 * 1000;
            originalCard.nextReviewDate = now + interval;
            await saveSetsToServer();
            
            currentCardIndexInQueue++;
            if (currentCardIndexInQueue < studyQueue.length) {
                displayCard();
            } else {
                flashcardView.style.display = 'none';
                welcomeView.style.display = 'block';
                alert("Study session complete!");
                renderSidebar();
            }
        }

        function handleFileSelect(event) {
            uploadedFile = event.target.files[0];
            if (uploadedFile) {
                setNameInput.value = uploadedFile.name.replace(/\.csv$/i, '');
                nameSetModal.style.display = 'flex';
                setNameInput.focus();
            }
            csvFileInput.value = '';
        }

        function closeModal() {
            nameSetModal.style.display = 'none';
            uploadedFile = null;
        }

        async function processAndSaveSet() {
            const setName = setNameInput.value.trim();
            if (!setName) {
                alert('Please enter a name for the set.'); return;
            }
            if (uploadedFile) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const cards = parseCSV(e.target.result);
                    if (cards && cards.length > 0) {
                        allSets.push({ name: setName, date: new Date().toISOString().split('T')[0], cards: cards });
                        await saveSetsToServer();
                        renderSidebar();
                    } else {
                        alert("Could not find any valid flashcards in the file.");
                    }
                };
                reader.readAsText(uploadedFile);
            }
            closeModal();
        }

        function parseCSV(csvText) {
            const rows = [];
            let inQuotedField = false, currentField = '', currentRow = [];
            csvText = csvText.replace(/\r\n/g, '\n');
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i], nextChar = csvText[i + 1];
                if (char === '"' && nextChar === '"') { currentField += '"'; i++; } 
                else if (char === '"') { inQuotedField = !inQuotedField; } 
                else if ((char === ',' || char === '\n') && !inQuotedField) {
                    currentRow.push(currentField.trim());
                    currentField = '';
                    if (char === '\n') {
                        if (currentRow.length > 1 || currentRow[0] !== '') rows.push(currentRow);
                        currentRow = [];
                    }
                } else { currentField += char; }
            }
            if (currentField || currentRow.length > 0) { currentRow.push(currentField.trim()); rows.push(currentRow); }
            if (rows.length < 2) return [];
            const header = rows.shift().map(h => h.toLowerCase().replace(/^\uFEFF/, ''));
            if (header[0] !== 'question' || header[1] !== 'answer' || header[2] !== 'explanation') {
                alert('Invalid CSV header. Must be: Question,Answer,Explanation'); return [];
            }
            return rows.filter(row => row.length === 3).map(row => ({ 
                Question: row[0], Answer: row[1], Explanation: row[2], timesSeen: 0, srsLevel: null, nextReviewDate: null
            }));
        }

        async function displayCard() {
            if (studyQueue.length === 0) return;
            const cardInfo = studyQueue[currentCardIndexInQueue];
            const originalCard = allSets[cardInfo.setIndex].cards[cardInfo.cardIndex];
            
            originalCard.timesSeen = (originalCard.timesSeen || 0) + 1;
            await saveSetsToServer();

            flashcardSetTitle.textContent = allSets[cardInfo.setIndex].name;
            questionEl.innerHTML = originalCard.Question.replace(/\n/g, '<br>');
            answerEl.innerHTML = `<strong>Answer:</strong> ${originalCard.Answer}`;
            explanationEl.innerHTML = originalCard.Explanation;

            flashcardEl.classList.remove('is-flipped');
            confidenceButtons.style.display = 'none';
            updateProgressBar();
            updateCardCounter(originalCard.timesSeen);
        }
        
        function updateProgressBar() {
            const progress = ((currentCardIndexInQueue + 1) / studyQueue.length) * 100;
            progressBar.style.width = `${progress}%`;
        }
        
        function updateCardCounter(timesSeen) {
             cardCounter.textContent = `Card ${currentCardIndexInQueue + 1} of ${studyQueue.length}`;
             const seenText = timesSeen === 1 ? '1st time' : `${timesSeen} times`;
             timesSeenCounter.textContent = `👀 Seen ${seenText}`;
        }
        
        // --- Start the App ---
        initialize();
    </script>
</body>
</html>